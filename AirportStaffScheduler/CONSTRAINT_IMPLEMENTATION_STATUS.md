# 约束规则实现状态检查

## 一、贵宾-头等舱派工规则实现状态

### （一）硬约束规则

#### ? 1. 人员资质匹配
**状态：已实现**
- 在 `task_scheduler.cpp` 中添加了 `isQualificationMatch()` 函数
- 在分配固定人选和普通员工时都进行了资质检查
- 使用位掩码检查员工是否具有任务要求的所有资质

#### ? 2. 人员临时任务占用
**状态：已实现（通过高优先级任务）**
- 用户确认演练等任务已通过新增高优先级任务实现
- 高优先级任务会优先分配，占用员工时间段

#### ? 3. 任务重叠规则
**状态：已实现**
- `TaskDefinition` 类中有 `allowOverlap()` 和 `maxOverlapTime()` 方法
- 支持针对单个任务单独设定是否允许重叠及最大重叠时间
- 在 `isTimeOverlap()` 函数中实现了重叠检查逻辑

#### ? 4. 值守任务派工
**状态：已实现**
- 通过 `TaskConfig` 配置固定人选
- 系统生成前台、调度、厅内值守任务
- 算法按规则指定对应班次派工，确保岗位无空缺

### （二）软约束规则

#### ? 1. 任务指派最大化
**状态：已实现**
- 代码中优先选择空闲的员工
- 尽可能多为员工指派任务，提升人力利用率

#### ? 2. 副班人员上下班弹性
**状态：已实现**
- 在 `task_scheduler.cpp` 中添加了副班优先逻辑
- 任务繁忙时，优先安排工时少的副班人员

#### ? 3. 均衡性
**状态：已实现**
- 优先选择当日任务时间最少的员工（`calculateEmployeeDailyTaskTime()`）
- 尽量保证值班人员工作、休息时间均衡

#### ? 4. 厅内和操作间任务分配
**状态：已实现**
- `scheduleHallMaintenanceTasks()` 函数实现了4人分组轮流值守
- 不值守的组执行操作间任务（`scheduleOperationRoomTasks()`）
- 优先从主班中选择人员

#### ? 5. 任务优先级
**状态：已实现**
- 优先级配置：调度(100) > 外场(80) > 厅内(60) > 前台协助(40) > 操作间(30)
- 在 `task_config.cpp` 的 `initializeTaskPriorities()` 中配置

#### ?? 6. 新员工任务偏好
**状态：部分实现**
- `TaskDefinition` 有 `canNewEmployee()` 方法
- 代码中有检查，但缺少 `EmployeeInfo` 中的 `isNewEmployee` 字段
- 当前简化处理：假设所有员工都可以（如果需要更严格检查，需要添加字段）

#### ? 7. 结果调整最小
**状态：已实现（装卸模块）**
- 装卸模块支持 `previous_tasks` 参数
- 优先复用上一次预排方案的分配

---

## 二、装卸派工规则实现状态

### （一）硬约束规则

#### ? 1. 人员资质匹配
**状态：已实现**
- 在 `load_scheduler.cpp` 中添加了资质检查
- 检查组内所有成员是否都有任务要求的资质（位掩码检查）

#### ? 2. 小组上班时间
**状态：已实现**
- 通过 `Shift` 类管理班次信息
- 小组各天上下班时间按表格制定，轮换进行

#### ? 3. 小组派工不拆组
**状态：已实现**
- 代码中按组分配，每组3人
- 非满编小组（如2人组）当日作为机动组（代码中会跳过不完整的组）

#### ? 4. 资源不足保障
**状态：已实现**
- 如果无法满足需求，标记为 `is_short_staffed=true`
- 需要人工干预，可通过机动小组、相邻小组等补充

#### ? 5. 人员配置标准
**状态：已实现**
- **进港任务**：正常3人，单进2.5t以上6人 ?
- **出港任务**：正常3人，单出2t以上6人 ?
- **短过站（≤90分钟）**：进出港货量和<2T用3人，≥2T用6人 ?
- **长过站（>90分钟）**：
  - 进港卸货：单进2.5t以上6人 ?
  - 出港装货：单出2t以上6人 ?
- **国际航班**：通常派2个组保障（6人）?

### （二）软约束规则

#### ? 1. 临近下班小组任务指派
**状态：已实现**
- 在综合得分计算中添加了 `off_duty_penalty`
- 如果任务会延误下班，优先选择当日工时较少的组
- 尽量减少为临近下班人员安排航班任务

#### ? 2. 组间任务约束
**状态：已实现**
- 在 `load_scheduler.cpp` 中检查小组是否能按时到达
- 考虑路程时间 + 工作时间不耽误飞机计划
- 使用 `StandDistance` 管理机位距离矩阵

#### ? 3. 任务保障优先级
**状态：已实现**
- 已报时 > 未报时 ?
- 进港 > 出港 ?
- 落地时间早的 > 落地时间晚的 ?
- 在 `sortTasksByPriority()` 函数中实现

#### ? 4. 早出港派工（08:00前）
**状态：已实现**
- 添加了 `is_early_departure` 判断
- 临近机位尽量同组保障
- 结合重量数据，确保各组疲劳度相对均衡（选择当日工时较少的组）

#### ? 5. 白班航班派工（08:00后）
**状态：已实现**
- 按 2组-3组-4组-5组-6组-7组-8组-1组循环指派
- 在 `rotation_order` 构建时，将load_group=1的组移到末尾
- 后续航班衔接不上可灵活互换（通过综合得分选择）

#### ?? 6. 排序与发布
**状态：部分实现**
- 进港按预落排序 ?（在 `sortTasksByPriority()` 中按落地时间排序）
- 出港按（预飞-60）排序 ?（任务开始时间已考虑）
- 算法提前预排 ?
- **自动发布功能**：需要在调用层实现（进港提前15分钟、出港提前75分钟）

#### ?? 7. 航班延误
**状态：部分实现**
- **延误航班未报时，系统自动清空预排小组**：需要在调用层实现
- 有报时后按最新报时派工 ?（通过 `hasReported()` 和 `report_time` 判断）

#### ? 8. 疲劳度
**状态：已实现**
- 通过 `block_periods` 参数支持班次占位
- 调度可通过系统指定班次在某时间区间占位，该时段算法不派工
- 占位结束后按正常轮班规则重新加入队列

#### ?? 9. 加班
**状态：部分实现**
- 下班时间不固定，允许加班 ?
- 保障航班任务前提下尽可能不加班 ?（通过优先选择工时少的组）
- **可针对每个班次设置是否允许加班**：需要在 `Shift` 类中添加字段
- **系统支持手动设置部分小组加班时间**：需要在调用层实现

#### ? 10. 下班顺序
**状态：已实现**
- 根据航班量决定下班时间 ?
- 按固定班次下班时间下班，航班任务开始时间在下班前可继续派工 ?
- 尽量减少为临近下班人员安排航班任务 ?（通过 `off_duty_penalty`）

#### ? 11. 均衡性
**状态：已实现**
- 各小组上班时间内指派任务数保持均衡 ?（通过选择当日工时较少的组）
- 单个组多个任务衔接避免过于紧张 ?（通过连续工作时长检查）
- 保障航后下班较迟班次，白班可少一轮降低疲劳度 ?（通过综合得分）

#### ? 12. 结果调整最小
**状态：已实现**
- 滚动派工时，尽可能减少上一次预排方案的调整
- 通过 `previous_tasks` 参数优先复用上一次的分配

#### ? 13. 小组休息
**状态：已实现**
- 任务较少时，优先为当日工时较少的小组分配任务
- 在综合得分计算中，`off_duty_penalty` 考虑了当日工时

---

## 需要补充的功能

### 1. 新员工标识
- 需要在 `EmployeeInfo` 类中添加 `isNewEmployee` 字段
- 在分配任务时检查 `canNewEmployee()` 和 `isNewEmployee`

### 2. 班次加班设置
- 需要在 `Shift` 类中添加 `allowOvertime` 字段
- 在分配任务时检查是否允许加班

### 3. 自动发布功能
- 需要在调用层实现自动发布逻辑
- 进港提前15分钟、出港提前75分钟自动发布任务

### 4. 航班延误处理
- 需要在调用层实现延误航班未报时自动清空预排小组的逻辑

---

## 总结

### 已完全实现的约束
- ? 人员资质匹配（两个模块）
- ? 任务重叠规则
- ? 值守任务派工
- ? 任务指派最大化
- ? 副班人员上下班弹性
- ? 均衡性
- ? 厅内和操作间任务分配
- ? 任务优先级
- ? 小组派工不拆组
- ? 人员配置标准
- ? 临近下班小组任务指派
- ? 组间任务约束
- ? 任务保障优先级
- ? 早出港派工
- ? 白班航班派工轮转
- ? 疲劳度控制
- ? 下班顺序
- ? 结果调整最小
- ? 小组休息

### 部分实现的约束
- ?? 新员工任务偏好（需要添加 `isNewEmployee` 字段）
- ?? 排序与发布（自动发布功能需要在调用层实现）
- ?? 航班延误（自动清空预排需要在调用层实现）
- ?? 加班（班次加班设置需要在 `Shift` 类中添加字段）

### 总体评价
两个派工算法基本满足所有核心约束规则。硬约束规则已全部实现，软约束规则大部分已实现。剩余的功能主要是在调用层或数据结构层面的补充，不影响核心调度逻辑。


